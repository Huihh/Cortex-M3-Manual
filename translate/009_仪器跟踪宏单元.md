# 9. 仪器跟踪宏单元 (Instrumentation Trace Macrocell Unit)

本章描述仪器跟踪宏单元 (ITM)。包含以下部分：

- 关于 ITM
- ITM 功能描述
- ITM 编程模型



## 9.1. 关于 ITM (About the ITM)

ITM 是一个可选的应用程序驱动 (application-driven) 的跟踪源，支持 printf 样式的调试来跟踪操作系统和应用程序事件，并生成诊断系统信息。



## 9.2. ITM 功能描述 (ITM functional description)

ITM 以包的方式生成跟踪信息。多个源可以产生包。如果多个源同时产生了包，ITM 仲裁包的输出顺序。这些源的优先级如下 (依次递减)：

- 软件跟踪。软件可以直接写 ITM 的刺激寄存器 (stimulus registers) 以产生包。
- 硬件跟踪。DWT 产生这些包，ITM 输出它们。
- 时间戳 (Time trace)。包生成的时间。ITM  有个 21-bit 的计数器用于产生时间戳。Cortex-M3 时钟或者串行线查看器 (SWV: Serial Wire Viewer) 的位时钟速率 (bitclock rate) 输出时钟的计数。



## 9.3. ITM 编程模型 (ITM programmers model)

表 9-1 列出了 ITM 的寄存器。依赖处理的实现，ITM 有的寄存器可能不存在。读不存在的寄存器将返回 0。

注：

- 在编写程序或使用 ITM 之前，必须使能调试异常和监视控制寄存器 (DEMCR: Debug Exception and Monitor Control Register)的 **TRCENA** 字段。
- 如果 ITM 流要求同步包，你必须在 DWT 中配置同步包速率。



| 地址                              | 名称                   | 类型 | 复位值      | 描述                                                     |
| --------------------------------- | ---------------------- | ---- | ----------- | -------------------------------------------------------- |
| 0xE000_0000 -         0xE000_007C | ITM_STIM0 - ITM_STIM31 | RW   | -           | 刺激端口寄存器 0-31 (Simulus Port Registers 0-31)        |
| 0xE000_0E00                       | ITM_TER                | RW   | 0x0000_0000 | 跟踪使能寄存器 (Trace Enable Register)                   |
| 0xE000_0E40                       | ITM_TPR                | RW   | 0x0000_0000 | ITM 跟踪特权寄存器 (ITM Trace Privilege Register)        |
| 0xE000_0E80                       | ITM_TCR                | RW   | 0x0000_0000 | 跟踪控制寄存器 (Trace Control Register)                  |
| 0xE000_0FD0                       | PID4                   | RO   | 0x0000_0004 | 外设身份识别寄存器 (Peripheral Identification Registers) |
| 0xE000_0FD4                       | PID5                   | RO   | 0x0000_0000 | 同上                                                     |
| 0xE000_0FD8                       | PID6                   | RO   | 0x0000_0000 | 同上                                                     |
| 0xE000_0FDC                       | PID7                   | RO   | 0x0000_0000 | 同上                                                     |
| 0xE000_0FE0                       | PID0                   | RO   | 0x0000_0001 | 同上                                                     |
| 0xE000_0FE4                       | PID1                   | RO   | 0x0000_00B0 | 同上                                                     |
| 0xE000_0FE8                       | PID2                   | RO   | 0x0000_003B | 同上                                                     |
| 0xE000_0FEC                       | PID3                   | RO   | 0x0000_0000 | 同上                                                     |
| 0xE000_0FF0                       | CID0                   | RO   | 0x0000_000D | 组件身份识别寄存器 (Component Identification registers)  |
| 0xE000_0FF4                       | CID1                   | RO   | 0x0000_00E0 | 同上                                                     |
| 0xE000_0FF8                       | CID2                   | RO   | 0x0000_0005 | 同上                                                     |
| 0xE000_0FFC                       | CID3                   | RO   | 0x0000_00B1 | 同上                                                     |



注：

在特权模式下可以访问 ITM 的所有寄存器。在用户模式下，所有的寄存器可读，只有在跟踪特权寄存器 (Trace Privilege Registers) 中相应的位被设置后，才能写刺激端口寄存器 (Stimulus Registers) 和 跟踪使能寄存器 (Trace Enable Registers) 。无效的模式下对写 ITM 寄存器会被丢弃。



下面描述了针对处理器指定实现的 ITM 寄存器。其它的寄存器在 **ARMv7-M Architectural Reference Manual** 中描述。



### 9.3.1. ITM 跟踪特权寄存器，ITM_TPR (ITM Trace Privilege Register, ITM_TPR)

ITM_TPR 寄存器特点如下：

目的：使操作系统能够控制用户代码可访问的刺激端口 (stimulus ports)。

用法限制：仅能在特权模式下写该寄存器。

配置：如果实现中 ITM 被配置了，则该寄存器是有效的。

属性：如下表 9-1。

![](E:\Work\ARM\pictures\Chapter 9\Snipaste_2019-07-15_17-21-26.png)

| 位     | 名称     | 功能                                                         |
| ------ | -------- | ------------------------------------------------------------ |
| [31:4] | -        | 保留                                                         |
| [3:0]  | PRIVMASK | 位掩码，用于使能 ITM 刺激端口上的跟踪：                                                   bit[0] = 刺激端口[7:0]                                                                                                             bit[1] = 刺激端口[15:8]                                                                                                               bit[2] = 刺激端口[23:16]                                                                                                          bit[3] = 刺激端口[31:24] |

