# 6. 嵌套向量中断控制器 (Nested Vectored Interrupt Controller)

该章节描述 NVIC，包含以下部分：

- 关于 NVIC
- NVIC 功能描述
- NVIC 编程模型



## 6.1. 关于 NVIC (About the NVIC)

NVIC 为处理器提供了可配置的中断处理能力：

- 改进的低延迟 (low-latency) 的异常和中断处理
- 控制电源管理



## 6.2. NVIC 功能描述 (NVIC functional description)

NVIC 可以支持 240 个中断，每个中断可以支持 256 个优先级。支持动态改变重点的优先级。NVIC 和处理器内核接口紧密耦合在一起，以支持低延迟中断处理和对晚到的 (late arriving) 中断进行高效处理。NVIC 维护着关于堆叠的或嵌套的中断，支持咬尾中断 (tail-chaining interrupts)。



只能从特权模式完全的访问 NVIC，但如果使用配置控制寄存器 (CCR: Configuration Control Register) 开启此功能，则会导致中断在用户模式进入挂起状态。任何其它的用户模式访问将导致总线 Fault 。



除特别说明外，可以使用字节，半字和字访问所有的 NVIC 寄存器。NVIC 的寄存器位于系统控制空间 (SCS: System Control Space)。

不管处理器是大端还是小端，所有的 NVIC 寄存器和系统调试寄存器都是小端。

处理器的异常处理在 **Exceptions** 章节描述。



### 6.2.1. 低功耗模式 (Low power modes)

实现时包括一个唤醒中断控制器 (WIC: Wake-up Interrupt Controller)。这使得处理器和 NVIC 进入一个非常低功耗的休眠模式，让 WIC 识别和确定中断优先级。

处理器完全实现了等待中断 (**WFI**: Wait For Interrupt)，等待事件 (**WFE**: Wait For Event) 和 发送事件 (**SE**: Send Event) 指令。此外，处理器还支持使用 **SLEEPONEXIT**，这将导致处理器内核在从异常处理返回到 **Thread** 模式时进进入睡眠模式。更多信息参见 **ARMv7-M Architecture Reference Manual** 。



### 6.2.2. 电平与脉冲中断 (Level versus pulse interrupts)

处理器同时支持电平和脉冲中断。在 ISR 访问设备清除中断之前，需要保持中断电平。脉冲中断是边缘模型的一种变体 (A pulse interrupt is a variant of an edge model)。



对于电平中断，如果在中断服务例程 (ISR) 返回之前没有取消中断信号电平。这个中断将再次进入挂起状态并再次被激活。这对于 FIFO 和基于缓冲区的设备尤其有用，因为它可以确保它们通过单个 ISR 或重复调用被耗尽，而不需要额外的工作。这意味着设备需要一直保持信号，直到设备为空。



对于脉冲中断，在 ISR 期间可以重新设置脉冲中断，这样中断就可以同时处于挂起状态和活动状态。应用程序设计必须确保在激活第一个脉冲之前第二个脉冲不会到达。挂起状态的第二个条目没有影响，因为它已经处于该状态。但是，如果中断在至少一个周期被认定过 (if the interrupt is asserted for at least one cycle)，则 NVIC 锁定 pend 位。当 ISR 激活时，pend 位被清除。如果中断在被激活时再次被认定，它可以再次锁定 pend 位。

脉冲中断主要用于速率或重复的外部信号。



## 6.3. NVIC 编程模型 (NVIC programmers model)

下表列出了 NVIC 的寄存器：

| 地址                      | 名称                    | 类型 | 复位值      | 描述                                                      |
| ------------------------- | ----------------------- | ---- | ----------- | --------------------------------------------------------- |
| 0xE000_E004               | ICTR                    | RO   | -           | 中断控制器类型寄存器 (Interrupt Controller Type Register) |
| 0xE000_E100 - 0xE000_E11C | NVIC_ISER0 -NVIC_ISER7  | RW   | 0x0000_0000 | 中断设置使能寄存器 (Interrupt Set-Enable Registers)       |
| 0xE000_E180 - 0xE000_E19C | NVIC_ICER0 -NVIC_ICER7  | RW   | 0x0000_0000 | 中断清除使能寄存器 (Interrupt Clear-Enable Registers)     |
| 0xE000_E200 - 0xE000_E21C | NVIC_ISPR0 - NVIC_ISPR7 | RW   | 0x0000_0000 | 中断设置挂起寄存器 (Interrupt Set-Pending Registers)      |
| 0xE000_E280 - 0xE000_E29C | NVIC_ICPR0 - NVIC_ICPR7 | RW   | 0x0000_0000 | 中断清除挂起寄存器 (Interrupt Clear-Pending Registers)    |
| 0xE000_E300 - 0xE000_E31C | NVIC_IABR0 - NVIC_IABR7 | RO   | 0x0000_0000 | 中断活动位寄存器 (Interrupt Active Bit Register)          |
| 0xE000_E400 - 0xE000_E41F | NVIC_IPR0 - NVIC_IPR59  | RW   | 0x0000_0000 | 中断优先级寄存器 (Interrupt Priority Register)            |



下面的部分描述了 NVIC 寄存器，这些是寄存器是特定于这个处理器实现的。其它的寄存器在 **ARMv7M Architecture Reference Manual** 中有详细说明。



#### 6.3.1. 中断控制器类型寄存器，ICTR (Interrupt Controller Type Register)

ICTR 寄存器的特点：

- 目的：表明 NVIC 支持的中断线个数。
- 用法限制： 没有。
- 配置：在所有处理器配置中该寄存器都是有效的。
- 属性：如下表所示。

![](E:\Work\ARM\pictures\Chapter 6\Snipaste_2019-07-10_14-08-18.png)

| 位     | 名称        | 功能                                                         |
| ------ | ----------- | ------------------------------------------------------------ |
| [31:4] | -           | 保留                                                         |
| [3:0]  | INTLINESNUM | 每组 32 条中断线的总数：                                                                         b0000 = 0...32                                                                                               b0001 = 33...64                                                                                                     b0010 = 65...96                                                                                                     b0011 = 96...128                                                                                                                      b0100 = 129...160                                                                                                                          b0101 = 161...192                                                                                                              b0110 = 193...224                                                                                                        b0111 = 225...256  (注: 处理器最大支持 240 个外部中断) |