10. 嵌入式跟踪宏单元 (Embedded Trace Macrocell)

本章描述嵌入式跟踪宏单元 (ETM: Embedded Trace Macrocell)。包含以下部分：

- 关于 ETM
- ETM 功能描述
- ETM 编程模型



## 10.1. 关于 ETM (About the ETM)

ETM 是个可选的调试组件，支持重构程序执行。ETM 被设计为一个高速 (high-speed)，低功耗 (low-power)  的调试工具，它仅支持指令跟踪。这将确保该区域最小化，并减少门计数。

ETM 实现了 **ARM ETM architecture v3.4**，在 **ARM Embedded Trace Macrocell Architecture Specification** 中查看。

ETM 将所有的 32-bit Thumb 指令作为单个的指令进行跟踪，ETM 跟踪指令作为一个普通的条件指令跟随在 **IT** 指令后面。解码器 (decompressor) 不需要参考 **IT** 指令。

也可以使用 CoreSight ETM-M3，或者带有跟踪端口接口单元的 Cortex-M3 (M3-TPIU)，作为 CoreSight 系统的一部分。



### 10.1.1. 特点 (Features)

ETM-M3 提供：

- 跟踪 16-bit 和 32-bit Thumb 指令。
- 4 个嵌入式 ICE 观察点输入 (EmbeddedICE watchpoint inputs)。
- 1 个带有嵌入式 ICE 输入的跟踪开始/停止块。
- 2 个外部输入。
- 1 个 24-byte  的 FIFO 队列。

查看 **Embedded Trace Macrocell Architecture Specification**，获取：

- 跟踪协议。
- 使用触发和过滤资源控制跟踪。

查看 **Cortex-M3 Integration and Implementation Manual** ，获取关于宏单元信号。



### 10.1.2. 配置选项 (Configurable options)

ETM-M3 宏包含以下配置输入：

- 外部输入的最大个数，详见 10.2.4 小节。
- 系统是否支持用于停止处理器的 FIFOFULL 机制，详见：10.2.1 小节。



# 10.2. ETM 功能描述 (ETM functional description)

图 10-1 显示了 ETM 的模块插图，并显示了 ETM 连接到跟踪端口接口单元 (TPIU) 的接口。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-02-30.png)

Cortex-M3 系统可以使用数据观察点和跟踪 (DWT) 和指令跟踪宏 (IEM) 组件执行低带宽数据 (low-bandwidth) 跟踪。

无论 ETM编程模型中的跟踪端口大小和跟踪端口模式的配置如何，ETM 跟踪输出是兼容 AMBA 跟踪总线 (ATB) 协议的。TPIU 从处理器导出跟踪信息。在实现时，可以使用其它 CoreSight 跟踪组件替换 TPIU。          

更多信息详见：

- 第 8 章节 数据观察点和跟踪单元。
- 第 9 章节 仪器跟踪宏单元。
- 第 11 章节 跟踪端口接口单元。
- 嵌入式跟踪宏架构规范 (Embedded Trace Macrocell Architecture Specification)。



ETM 为使用多个跟踪源的系统提供了一个跟踪 ID 寄存器。即使只使用一个跟踪源也必须配置这个寄存器。



### 10.2.1. 资源 (Resources)

因为 ETM 不会产生数据跟踪信息，较低的带宽降低了对复杂触发功能的需求。这意味着 ETM 只包含 ETM体系结构允许的可能资源的一小部分子集。



下表列出了 Cortex-M3 资源。

| Feature                                       | Present on ETM-M3    |
| --------------------------------------------- | -------------------- |
| 架构版本                                      | ETMv3.4              |
| 地址比较器对                                  | 0                    |
| 数据比较器                                    | 0                    |
| 内容 ID 比较器                                | 0                    |
| 内从映射解码器 (MMDs)                         | 0                    |
| 计数器                                        | 0                    |
| 序列发生器 (Sequencer)                        | No                   |
| 开始/停止块                                   | Yes                  |
| 嵌入式 ICE 比较器                             | 4                    |
| 外部输入                                      | 2                    |
| 外部输出                                      | 0                    |
| 扩展的外部输入                                | 0                    |
| 扩展的外部输入选择器                          | 0                    |
| FIFOFULL                                      | Yes                  |
| FIFOFULL 等级设置                             | Yes                  |
| 分支广播                                      | Yes                  |
| ASIC 控制寄存器                               | No                   |
| 数据抑制 (Data suppression)                   | No                   |
| 对寄存器的软件访问                            | Yes                  |
| 可读寄存器                                    | Yes                  |
| FIFO 大小                                     | 24-Byte              |
| 最小端口大小                                  | 8-bit                |
| 最大端口大小                                  | 8-bit                |
| 通用端口模式                                  | -                    |
| 通用半速时钟 (Normal half-rate clocking, 1:1) | Yes - asynchronous   |
| 多路端口模式                                  | -                    |
| 多路半速时钟 (Demux half-rate clocking, 1:2)  | No                   |
| 多路复用端口模式 (Mux port mode, 2:1)         | No                   |
| 1:4 port mode                                 | No                   |
| 动态端口模式，包括停止 (including stalling)   | No. 支持异步端口模式 |
| Load PC first                                 | No                   |
| Fetch comparisons                             | No                   |
| Load data traced                              | No                   |



可以使用相同的机制配置跟踪使能时间和触发事件。对于每一个事件，使用一个 17-bit 的寄存器定义事件。这个寄存器提供：

- 资源 A，bits[6:0]
- 资源 B，bits[13:7]
- 一个布尔函数，bits[16:14]

下表 10-2 显示了布尔函数的编码。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-44-07.png)



下表 10-3 显示了用于资源标识的编码。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-45-16.png)



### 10.2.2. 周期同步 (Periodic synchronization)

ETM 使用每 1024 字节跟踪的固定同步包生成频率。



### 10.2.3. 数据和指令地址比较资源 (Data and instruction address compare resources)

DWT 在提供调试功能的数据总线上提供了 4 个地址比较器。在 DWT 单元中，可以指定匹配触发的函数，其中一个函数是生成 ETM 匹配输入。这些输入被呈现给 ETM 作为嵌入式电路仿真器(ICE: In Circuit Emulator) 比较器输入。

单个 DWT 资源可以触发 ETM 事件，还可以直接从同一个事件生成仪器跟踪。

可以分别配置 4 个 DWT 比较器来与当前执行指令的地址进行比较，以允许 ETM 访问指令地址比较资源。这些输入作为嵌入式 ICE 比较器的输入提供给 ETM 。DWT根据处理器的实现提供 1 个或 4 个比较器。

注：使用 DWT 比较器作为指令地址比较器，可以减少可用数据地址比较的数量。

关于 DWT 的更多信息，详见 第 8 章节。



### 10.2.4. 外部输入 (External inputs)

2 个外部输入，**ETMEXTIN[1:0]** ，启用额外的组件为 ETM 生成触发器和启用信号。



### 10.2.5. 开始/停止块 (Start/stop block)

开始/停止块提供了一个单位 (a single-bit) 资源，可以用作资源逻辑的其他部分的输入，包括跟踪启用逻辑。开始/停止块只能通过使用 ETM 的嵌入式 ICE 输入来控制。DWT 控制这些输入。



如果 **ETMTESSEICR** 中选择作为启动资源的任何嵌入式 ICE 观察点输入拉高，则将开始/停止块设置为开启状态。如果 **ETMTESSEICR** 中选择作为停止资源的任何嵌入式 ICE 观察点输入拉低，则将开始/停止块设置为停止状态。



如果 **ETMTECR1** 中的 bit[25] 位为 1，只有在开始/停止块处于启动状态时才会启用跟踪。



跟踪仅在计算跟踪使能事件 (Trace Enable Event) 的结果为真时才启用。通过设置 **ETMTEEVR**寄存器设置为 0x6F，可以将此事件设置为总是真。更多信息详见 **Embedded Trace Macrocell Architecture Specification** 。



### 10.2.6. 触发 (Triggering)























































