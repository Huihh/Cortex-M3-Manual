# 10. 嵌入式跟踪宏单元 (Embedded Trace Macrocell)

本章描述嵌入式跟踪宏单元 (ETM: Embedded Trace Macrocell)。包含以下部分：

- 关于 ETM
- ETM 功能描述
- ETM 编程模型



## 10.1. 关于 ETM (About the ETM)

ETM 是个可选的调试组件，支持重构程序执行。ETM 被设计为一个高速 (high-speed)，低功耗 (low-power)  的调试工具，它仅支持指令跟踪。这将确保该区域最小化，并减少门计数。

ETM 实现了 **ARM ETM architecture v3.4**，在 **ARM Embedded Trace Macrocell Architecture Specification** 中查看。

ETM 将所有的 32-bit Thumb 指令作为单个的指令进行跟踪，ETM 跟踪指令作为一个普通的条件指令跟随在 **IT** 指令后面。解码器 (decompressor) 不需要参考 **IT** 指令。

也可以使用 CoreSight ETM-M3，或者带有跟踪端口接口单元的 Cortex-M3 (M3-TPIU)，作为 CoreSight 系统的一部分。



### 10.1.1. 特点 (Features)

ETM-M3 提供：

- 跟踪 16-bit 和 32-bit Thumb 指令。
- 4 个嵌入式 ICE 观察点输入 (EmbeddedICE watchpoint inputs)。
- 1 个带有嵌入式 ICE 输入的跟踪开始/停止块。
- 2 个外部输入。
- 1 个 24-byte  的 FIFO 队列。

查看 **Embedded Trace Macrocell Architecture Specification**，获取：

- 跟踪协议。
- 使用触发和过滤资源控制跟踪。

查看 **Cortex-M3 Integration and Implementation Manual** ，获取关于宏单元信号。



### 10.1.2. 配置选项 (Configurable options)

ETM-M3 宏包含以下配置输入：

- 外部输入的最大个数，详见 10.2.4 小节。
- 系统是否支持用于停止处理器的 FIFOFULL 机制，详见：10.2.1 小节。



# 10.2. ETM 功能描述 (ETM functional description)

图 10-1 显示了 ETM 的模块插图，并显示了 ETM 连接到跟踪端口接口单元 (TPIU) 的接口。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-02-30.png)

Cortex-M3 系统可以使用数据观察点和跟踪 (DWT) 和指令跟踪宏 (IEM) 组件执行低带宽数据 (low-bandwidth) 跟踪。

无论 ETM编程模型中的跟踪端口大小和跟踪端口模式的配置如何，ETM 跟踪输出是兼容 AMBA 跟踪总线 (ATB) 协议的。TPIU 从处理器导出跟踪信息。在实现时，可以使用其它 CoreSight 跟踪组件替换 TPIU。          

更多信息详见：

- 第 8 章节 数据观察点和跟踪单元。
- 第 9 章节 仪器跟踪宏单元。
- 第 11 章节 跟踪端口接口单元。
- 嵌入式跟踪宏架构规范 (Embedded Trace Macrocell Architecture Specification)。



ETM 为使用多个跟踪源的系统提供了一个跟踪 ID 寄存器。即使只使用一个跟踪源也必须配置这个寄存器。



### 10.2.1. 资源 (Resources)

因为 ETM 不会产生数据跟踪信息，较低的带宽降低了对复杂触发功能的需求。这意味着 ETM 只包含 ETM体系结构允许的可能资源的一小部分子集。



下表列出了 Cortex-M3 资源。

| Feature                                       | Present on ETM-M3    |
| --------------------------------------------- | -------------------- |
| 架构版本                                      | ETMv3.4              |
| 地址比较器对                                  | 0                    |
| 数据比较器                                    | 0                    |
| 内容 ID 比较器                                | 0                    |
| 内从映射解码器 (MMDs)                         | 0                    |
| 计数器                                        | 0                    |
| 序列发生器 (Sequencer)                        | No                   |
| 开始/停止块                                   | Yes                  |
| 嵌入式 ICE 比较器                             | 4                    |
| 外部输入                                      | 2                    |
| 外部输出                                      | 0                    |
| 扩展的外部输入                                | 0                    |
| 扩展的外部输入选择器                          | 0                    |
| FIFOFULL                                      | Yes                  |
| FIFOFULL 等级设置                             | Yes                  |
| 分支广播                                      | Yes                  |
| ASIC 控制寄存器                               | No                   |
| 数据抑制 (Data suppression)                   | No                   |
| 对寄存器的软件访问                            | Yes                  |
| 可读寄存器                                    | Yes                  |
| FIFO 大小                                     | 24-Byte              |
| 最小端口大小                                  | 8-bit                |
| 最大端口大小                                  | 8-bit                |
| 通用端口模式                                  | -                    |
| 通用半速时钟 (Normal half-rate clocking, 1:1) | Yes - asynchronous   |
| 多路端口模式                                  | -                    |
| 多路半速时钟 (Demux half-rate clocking, 1:2)  | No                   |
| 多路复用端口模式 (Mux port mode, 2:1)         | No                   |
| 1:4 port mode                                 | No                   |
| 动态端口模式，包括停止 (including stalling)   | No. 支持异步端口模式 |
| Load PC first                                 | No                   |
| Fetch comparisons                             | No                   |
| Load data traced                              | No                   |



可以使用相同的机制配置跟踪使能时间和触发事件。对于每一个事件，使用一个 17-bit 的寄存器定义事件。这个寄存器提供：

- 资源 A，bits[6:0]
- 资源 B，bits[13:7]
- 一个布尔函数，bits[16:14]

下表 10-2 显示了布尔函数的编码。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-44-07.png)



下表 10-3 显示了用于资源标识的编码。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_10-45-16.png)



### 10.2.2. 周期同步 (Periodic synchronization)

ETM 使用每 1024 字节跟踪的固定同步包生成频率。



### 10.2.3. 数据和指令地址比较资源 (Data and instruction address compare resources)

DWT 在提供调试功能的数据总线上提供了 4 个地址比较器。在 DWT 单元中，可以指定匹配触发的函数，其中一个函数是生成 ETM 匹配输入。这些输入被呈现给 ETM 作为嵌入式电路仿真器(ICE: In Circuit Emulator) 比较器输入。

单个 DWT 资源可以触发 ETM 事件，还可以直接从同一个事件生成仪器跟踪。

可以分别配置 4 个 DWT 比较器来与当前执行指令的地址进行比较，以允许 ETM 访问指令地址比较资源。这些输入作为嵌入式 ICE 比较器的输入提供给 ETM 。DWT根据处理器的实现提供 1 个或 4 个比较器。

注：使用 DWT 比较器作为指令地址比较器，可以减少可用数据地址比较的数量。

关于 DWT 的更多信息，详见 第 8 章节。



### 10.2.4. 外部输入 (External inputs)

2 个外部输入，**ETMEXTIN[1:0]** ，启用额外的组件为 ETM 生成触发器和启用信号。



### 10.2.5. 开始/停止块 (Start/stop block)

开始/停止块提供了一个单位 (a single-bit) 资源，可以用作资源逻辑的其他部分的输入，包括跟踪启用逻辑。开始/停止块只能通过使用 ETM 的嵌入式 ICE 输入来控制。DWT 控制这些输入。



如果 **ETMTESSEICR** 中选择作为启动资源的任何嵌入式 ICE 观察点输入拉高，则将开始/停止块设置为开启状态。如果 **ETMTESSEICR** 中选择作为停止资源的任何嵌入式 ICE 观察点输入拉低，则将开始/停止块设置为停止状态。



如果 **ETMTECR1** 中的 bit[25] 位为 1，只有在开始/停止块处于启动状态时才会启用跟踪。



跟踪仅在计算跟踪使能事件 (Trace Enable Event) 的结果为真时才启用。通过设置 **ETMTEEVR**寄存器设置为 0x6F，可以将此事件设置为总是真。更多信息详见 **Embedded Trace Macrocell Architecture Specification** 。



### 10.2.6. 触发 (Triggering)

ETM 提供了一个触发资源，可用于标识跟踪运行中的一个点。触发的产生不会以任何方式影响跟踪，但是触发将在跟踪流中输出，还可以传递给其他跟踪组件或用于停止处理器。外部跟踪端口分析仪器可以使用触发来确定何时开始和停止捕获跟踪。



### 10.2.7. 接口 (Interfaces)

ETM-M3 有以下 3 个外部接口：

- **ATB** ：32-bit 高级跟踪总线，提供跟踪宏单元的输出。关于这个接口的更多信息，详见 **AMBA 3 ATB Protocol Specification** 。
- **APB** ：高级外设总线，为宏单元提供控制接口。更多信息，详见 **AMBA 3 APB Protocol Specification** 。
- **CTI** ：你的实现可以提供一个交叉触发器接口 (CTI: Cross Trigger Interface) 来管理处理器内核，ETM 和 TPIU 之间触发器和控制信号的互连。你的 Cortex-M3 处理器的实现决定了哪一个 ETM 函数对 CTI 是可见的。



推荐的 CTI 连接：

下表 10-4 和 表 10-5 显示了为 Cortex-M3 系统推荐的 CTI 连接。

注：

这些表显示的是 ARM 标准连接，实际的连接是实现定义的。检查设备供应商提供的文档，查看对这些连接的任何更改。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_14-05-52.png)



![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_14-06-36.png)



### 10.2.8. 操作 (Operation)

ETM-M3 实现了 ARM 嵌入式跟踪宏协议的 V3.4 版本。详细信息，参见 **Embedded Trace Macrocell Architecture Specification** 和 10.3 小节 ETM 编程模型。



## 10.3. ETM 编程模型 (ETM Programmers model)

本节描述用于编程寄存器的机制，这些寄存器用于设置宏单元的跟踪和触发工具。编程模型使你能够使用ETM 寄存器来控制宏单元。



### 10.3.1. 操作模式和执行模式 (Modes of operation and execution)

当 ETM 启动或重置时，在启用跟踪之前，必须对所有没有体系结构重置状态 (do not have an architected reset state) 的寄存器进行编程。如果不这么做，跟踪结果是不可预测的 (UNPREDICTABLE)。

在编程 ETM 寄存器时，必须同时启用所有更改。为此，应该使用 **ETMCR** 中的编程位。详见 **主控制寄存器 (ETMCR: Main Control Register)** 。

当编程位被设置为 0，则不能写 **ETMCR** 之外的其它寄存器，因为这可能导致不可预测 (UNPREDICABLE) 的行为。

当编程位被设置为 1，则不能改变 **ETMCR** 中的其它位。当 ETMSR 的 bit[1] 设置为 1 时，必须只更改ETMCR 的编程位以外的位的值。ARM 推荐在修改 **ETMCR** 时，使用读-改-写流程操作。



### 10.3.2. 寄存器 (Register summary)

表 10-6 显示了 ETM 的寄存器。

| 地址        | 名称          | 复位值      | 类型 | 描述                                                         |
| ----------- | ------------- | ----------- | ---- | ------------------------------------------------------------ |
| 0xE004_1000 | ETMCR         | 0x0000_0411 | RW   | 主控制寄存器 (Main Control Regisrer)                         |
| 0xE004_1004 | ETMCCR        | 0x8C80_0000 | RO   | 可配置代码寄存器 (Configuration Code Register)               |
| 0xE004_1008 | ETMTRIGGER    | -           | RW   | 见 **ARM Embedded Trace Macrocell Architecture Specification** |
| 0xE004_1010 | ETMSR         | -           | RW   | 同上                                                         |
| 0xE004_1014 | ETMSCR        | 0x0002_0D09 | RO   | 系统配置寄存器 (System Configuration Register)               |
| 0xE004_1020 | ETMTEEVR      | -           | RW   | 见 **ARM Embedded Trace Macrocell Architecture Specification** |
| 0xE004_1024 | ETMTECR1      | -           | RW   | 跟踪使能控制 1 寄存器 (TraceEnable Control 1 Register)       |
| 0xE004_1028 | ETMFFLR       | -           | RW   | 见 **ARM Embedded Trace Macrocell Architecture Specification** |
| 0xE004_11E0 | ETMSYNCFR     | 0x0000_0400 | RO   | 同上                                                         |
| 0xE004_11E4 | ETMIDR        | 0x4114_F242 | RO   | ID 寄存器                                                    |
| 0xE004_11E8 | ETMCCER       | 0x0014_1800 | RO   | 可配置代码扩展寄存器 (Configuration Code Extension Register) |
| 0xE004_11F0 | ETMTESSEICR   | -           | RW   | 跟踪使能开始/停止嵌入式 ICE 控制寄存器 (TraceEnable Start/Stop EmbeddedICE Control Register) |
| 0xE004_1200 | ETMTRACEIDR   | 0x0000_0000 | RW   | 见 **ARM Embedded Trace Macrocell Architecture Specification** |
| 0xE004_1208 | ETMIDR2       | 0x0000_0000 | RO   | 同上                                                         |
| 0xE004_1314 | ETMPDSR       | 0x0000_0001 | RO   | 设备断电状态寄存器 (Device Power-Down Status Register)       |
| 0xE004_1EE0 | ITMISCIN      | -           | RO   | 集成测试杂项输入 (Intergration Test Miscellaneous Inputs)    |
| 0xE004_1EE8 | ITTRIGOUT     | -           | WO   | 集成测试触发输出 (Intergration Test Trigger Out)             |
| 0xE004_1EF0 | ETM_ITATBCTR2 | -           | RO   | ETM 集成测试 ATB 控制 2 (ETM Integration Test ATB Control 2) |
| 0xE004_1EF8 | ETM_ITATBCTR0 | -           | WO   | ETM 集成测试 ATB 控制 0 (ETM Integration Test ATB Control 0) |
| 0xE004_1F00 | ETMITCTRL     | 0x0000_0000 | RW   | 见 **ARM Embedded Trace Macrocell Architecture Specification** |
| 0xE004_1FA0 | ETMCLAIMSET   | -           | RW   | 同上                                                         |
| 0xE004_1FA4 | ETMCLAIMCLR   | -           | RW   | 同上                                                         |
| 0xE004_1FB0 | ETMLAR        | -           | RW   | 同上                                                         |
| 0xE004_1FB4 | ETMLSR        | 0xE004_1FA0 | RO   | 同上                                                         |
| 0xE004_1FB8 | ETMAUTHSTATUS | -           | RO   | 同上                                                         |
| 0xE004_1FCC | ETMDEVTYPE    | 0x0000_0013 | RO   | 同上                                                         |
| 0xE004_1FD0 | ETMPIDR4      | 0x0000_0004 | RO   |                                                              |
| 0xE004_1FD4 | ETMPIDR5      | 0x0000_0000 | RO   |                                                              |
| 0xE004_1FD8 | ETMPIDR6      | 0x0000_0000 | RO   |                                                              |
| 0xE004_1FDC | ETMPIDR7      | 0x0000_0000 | RO   |                                                              |
| 0xE004_1FE0 | ETMPIDR0      | 0x0000_0024 | RO   |                                                              |
| 0xE004_1FE4 | ETMPIDR1      | 0x0000_00B9 | RO   |                                                              |
| 0xE004_1FE8 | ETMPIDR2      | 0x0000_002B | RO   |                                                              |
| 0xE004_1FEC | ETMPIDR3      | 0x0000_0000 | RO   |                                                              |
| 0xE004_1FF0 | ETMCIDR0      | 0x0000_000D | RO   | 同上                                                         |
| 0xE004_1FF4 | ETMCIDR1      | 0x0000_0090 | RO   |                                                              |
| 0xE004_1FF8 | ETMCIDR2      | 0x0000_0005 | RO   |                                                              |
| 0xE004_1FFC | ETMCIDR3      | 0x0000_00B1 | RO   |                                                              |



### 10.3.3. 主控制寄存器，ETMCR (Main Control Register)

ETMCR 寄存器特点描述：

目的：控制 ETM 的一般操作，例如：是否启用跟踪。

用法限制：没有。

配置：仅当处理器配置为使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_15-22-09.png)

| 位      | 名称                  | 功能                                                         |
| ------- | --------------------- | ------------------------------------------------------------ |
| [31:22] | -                     | RAZ                                                          |
| [21]    | Port size[3]          | 这个位是实现的，但是没有函数。ETM 复位时设置为 0。           |
| [20:18] | -                     | 保留                                                         |
| [17:16] | Port mode[1:0]        | 这个位是实现的，但是没有函数。ETM 复位时设置为 0。           |
| [15:14] | -                     | 保留                                                         |
| [13]    | Port mode[2]          | 这个位是实现的，但是没有函数。ETM 复位时设置为 0。           |
| [12]    | -                     | 保留                                                         |
| [11]    | ETM port selection    | 此位可用于控制实现中的其他跟踪组件。                                                                     0：ETMEN is LOW                                                                                                                    1：ETMEN is HIGH                                                                                                                          跟踪软件工具必须设置此位，以确保从这个 ETM 使能跟踪输出。                   ETM 复位时设置为 0。 |
| [10]    | ETM programming       | 这个位必须在 ETM 编程序列开始时设置为 1。当此位设置为1时，将阻止跟踪。ETM 复位时设置为 1。 |
| [9]     | Debug request control | 当设置为 1 时，触发事件发生，在观察到 **DBGACK** 时，将断言 **DBGRQ** 输出。这使得 ARM 处理器被迫进入调试状态。ETM 复位时设置为 0。 |
| [8]     | Branch output         | 当设置为 1 时，将输出所有分支地址，即使分支是直接的分支指令。设置此位可以在不访问正在执行的代码的内存映像的情况下重构程序流。           当设置为1时，将生成更多的跟踪数据，这可能会影响跟踪系统的性能。不管这个位的状态如何，都会跟踪关于分支执行的信息。ETM 复位时设置为 0。 |
| [7]     | Stall processor       | **FIFOFULL** 输出可以用来停止处理器，防止溢出。只有当该位设置为 1 时，才会启用 **FIFOFULL** 输出。当该位为 0 时，**FIFOFULL** 输出始终保持低，如果跟踪包太多，**FIFO** 就会溢出。一旦 **FIFO** 耗尽，如果发生溢出，跟踪将在没有损坏的情况下恢复。ETM 复位时设置为 0。 |
| [6:4]   | Port size[2:0]        | ETM-M3 对用于跟踪的外部引脚没有影响。这些位是实现的，但没有使用。ETM 复位时设置为 0b001。 |
| [3:1]   | -                     | 保留                                                         |
| [0]     | ETM power down        | 实现可以使用这个位来控制 ETM 是否处于低功耗状态。在调试会话开始时，跟踪软件工具必须清除这个位。当该位设置为 1 时，可能会忽略对某些寄存器和字段的写操作。你可写以下寄存器和字段：                                      1. ETMCR bit[0]                                                                                                     2. ETMLAR                                                                                                                               3. ETMCLAIMSET 寄存器                                                                                             4. ETMCLAIMCLR 寄存器                                                                                                                                  当 ETMCR 将该位设置为 1 时，可能会忽略其它位。ETM 复位时设置为1。 |



### 10.3.4. 可配置代码寄存器，ETMCCR (Configuration Code Register)

ETMCCR 寄存器特点如下：

目的：使软件能够读取特定于实现的 ETM 的配置。

用法限制：没有。

配置：该寄存器仅在处理器配置了使用 ETM。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-16_18-18-38.png)

| 位      | 名称                                | 功能                                                         |
| ------- | ----------------------------------- | ------------------------------------------------------------ |
| [31]    | ETM ID register present             | 这个位的值是 1，表示存在 **ETMIDR** 寄存器 0x79，并定义了正在使用的ETM 体系结构版本。 |
| [30:28] | -                                   | 保留                                                         |
| [27]    | Coprocessor and  Memory access      | 这个位的值是 1，表示支持对寄存器的内存映射访问。             |
| [26]    | Trace start/stop block present      | 这个位的值是 1,表明跟踪开始/停止块是存在的。                 |
| [25:24] | Number of Context ID Comparators    | 这些位的值为 b00，表示没有实现 Context ID 比较器。           |
| [23]    | **FIFOFULL** logic present          | 这个位的值是 1，表明在 ETM 中存在 **FIFOFULL logic** 。要使用**FIFOFULL**， 系统也必须支持函数，在 **ETMSCR** 的 bit[8] 位表明。 |
| [22:20] | Number of external outputs          | 这些位的值是 b000，表示不支持外部输出。                      |
| [19:17] | Number of external inputs           | 这些位的值在 b000 和 b010 之间，表示系统中实现的外部输入的数量，从 0 到 2 。 |
| [16]    | Sequencer present                   | 该位的值为 0，表示没有实现序列发生器 (Sequencer)。           |
| [15:13] | Number of counters                  | 这些位的值为 b000，表示没有实现计数器。                      |
| [12:8]  | Number of memory map decoders       | 这些位的值是 b00000，表明内存映射解码输入没有实现。          |
| [7:4]   | Number of data value comparators    | 这些位的值为 b0000，表示没有实现数据值比较器。               |
| [3:0]   | Number of addrress comparator pairs | 这些位的值为 b0000，表示没有实现地址比较器对。               |



### 10.3.5. 系统配置寄存器，ETMSCR (System Configuration Register)

ETMSCR 寄存器特点：

目的：显示 ETM 宏单元实现支持的 ETM 特性。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_09-57-52.png)

| 位      | 名称                    | 功能                                                         |
| ------- | ----------------------- | ------------------------------------------------------------ |
| [31:18] | -                       | 保留                                                         |
| [17]    | No Fetch comparisons    | 这个位的值是 1，表示没有实现 **Fetch comparisons** 。        |
| [16:15] | -                       | 保留                                                         |
| [14:12] | (N-1)                   | 这些位表示支持的处理器数量 (减 1)。                          |
| [11]    | Port mode supported     | 如果支持当前选择的端口模式，这个比特读取为 1。这对 TPIU 跟踪端口没有影响。 |
| [10]    | Port size supported     | 如果支持当前选择的端口大小，则该位读取为 1。这对 TPIU 跟踪端口没有影响。 |
| [9]     | Maximum port size [3]   | 最大 ETM 端口大小 bit[3]。这个位与 bit[2:0] 一起使用。它的值为 0。这对 TPIU 跟踪端口没有影响。 |
| [8]     | **FIFOFULL** supported  | 这个位的值是 1，表示支持 **FIFOFULL** 。此位与 **ETMCCR** 的 bit[23] 一起使用。 |
| [7:4]   | -                       | 保留，读返回 0。                                             |
| [3]     | -                       | 保留，读返回 1。                                             |
| [2:0]   | Maximum port size [2:0] | 最大 ETM 端口大小 bit[2:0]。这个位与 bit[9] 一起使用。它的值为 0b001。 |



### 10.3.6. 跟踪使能控制 1 寄存器，ETMTECR1 (TraceEnable Control 1 Register)

ETMTECR1 寄存器的特点：

目的： 开启用于启用跟踪的开始/停止逻辑。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_10-15-42.png)

| 位      | 名称                 | 功能                                                         |
| ------- | -------------------- | ------------------------------------------------------------ |
| [31:26] | -                    | 保留                                                         |
| [25]    | Trace control enable | 跟踪开始/停止使能。                                                                                                                          0：跟踪不受跟踪开始/停止逻辑的影响。                                                                                1：跟踪由为跟踪开始/停止逻辑配置的跟踪 on 和 off 地址控制。                                            跟踪开始/停止资源 0x5F，不受这个位的值的影响。 |
| [24:0]  | -                    | 保留                                                         |



 ### 10.3.7. ID 寄存器，ETMIDR (ID Register)

ETMIDR 寄存器特点：

目的：保持 ETM 体系结构多样性，并为 ETM 定义编程模型。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_10-22-54.png)

| 位      | 名称                             | 功能                                                         |
| ------- | -------------------------------- | ------------------------------------------------------------ |
| [31:24] | Implementor code                 | 这些位将 ARM 识别为处理器的实现者。这些位的值是 01000001。   |
| [23:21] | -                                | 保留                                                         |
| [20]    | Branch packet encoding           | 该位的值为 1，表示实现了可选的分支包编码。                   |
| [19]    | Security Extensions support      | 这个位的值是 0，表示 ETM 的行为就像处理器一直处于安全状态一样。 |
| [18]    | 32-bit Thumb instruction tracing | 这个位的值是 1，表示一条 32-bit Thumb 指令作为一条单独的指令被跟踪。 |
| [17]    | -                                | 保留                                                         |
| [16]    | Load PC first                    | 该位的值为 0，表示不支持数据跟踪。                           |
| [15:12] | Processor family                 | 这些位的值是 b1111，表示处理器族没有在这个寄存器中标识。     |
| [11:8]  | Major ETM architecture version   | 这些位的值是 b0010，表示主体系结构版本号为 3， ETMv3         |
| [7:4]   | Minor ETM architecture version   | 这些位的值是 b0100，表示次体系结构版本号为 4                 |
| [3:0]   | Implementation revision          | 这些位的值为 b0010，表示实现修订 2。                         |



### 10.3.8. 可配置代码扩展寄存器，ETMCCER (Configuration Code Extension Register)

ETMCCER 寄存器特点如下：

目的：在 **ETMCCR** 中保存 ETM 配置信息的附加信息。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_10-38-08.png)

| 位      | 名称                                                      | 功能                                                         |
| ------- | --------------------------------------------------------- | ------------------------------------------------------------ |
| [31:22] | -                                                         | 保留，读返回 0。                                             |
| [21]    | EmbeddedICE behavior control implemented                  | 这个位的值是 0，表示没有实 **ETMEIBCR**                      |
| [20]    | Trace Start/Stop block uses EmbeddedICE watchpoint inputs | 这个位的值是 1，表示跟踪开始/停止块使用EmbeddedICE 观察点输入。 |
| [19:16] | EmbeddedICE watchpoint inputs                             | 这些位的值为 b0100，表明实现的EmbeddedICE 观察点输入的个数为 4。这些输入来自 DWT。 |
| [15:13] | Instrumentation resources                                 | 这些位的值是 b000，表示不支持任何检测资源。                  |
| [12]    | Data address comparisons                                  | 该位的值为 1，表示不支持数据地址比较器。                     |
| [11]    | Readable registers                                        | 这个位的值是 1，表示所有寄存器都是可读的。                   |
| [10:3]  | Extended external input bus                               | 这些位的值为 0，表示没有实现扩展的外部输入总线。             |
| [2:0]   | Extended external input selectors                         | 这些位的值为 0，表示没有实现扩展的外部输入选择器。           |



### 10.3.9.  跟踪使能开始/停止嵌入式 ICE 控制寄存器，ETMTESSEICR (TraceEnable Start/Stop EmbeddedICE Control Register)

ETMTESSEICR 寄存器特点：

目的：指定用于控制开始/停止资源的 **EmbeddedICE** 观察点比较器输入。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_10-59-51.png)

| 位      | 名称                     | 功能                                                         |
| ------- | ------------------------ | ------------------------------------------------------------ |
| [31:20] | -                        | 保留，读返回 0。                                             |
| [19:16] | Stop resource selection  | 将这些位设置为 1，选择相应的 **EmbeddedICE** 观察点输入作为**TraceEnable** 停止资源。bit[16] 对应输入1，bit[17] 对应输入2，bit[18] 对应输入3，bit[19] 对应输入4 |
| [15:4]  | -                        | 保留，读返回 0。                                             |
| [3:0]   | Start resource selection | 将这些位设置为 1，选择相应的 **EmbeddedICE** 观察点输入作为**TraceEnable** 开始资源。bit[0] 对应输入1，bit[1] 对应输入2，bit[2] 对应输入3，bit[3] 对应输入4 |



### 10.3.10. 设备断电状态寄存器，ETMPDSR (Device Power-Down Status Register)

ETMPDSR 寄存器特点：

目的：表示 ETM 断电的状态。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_11-06-42.png)

| 位     | 名称           | 功能                                                         |
| ------ | -------------- | ------------------------------------------------------------ |
| [31:1] | -              | 保留，读返回 0。                                             |
| [0]    | ETM powered up | 此位的值指示是否可以访问 ETM 跟踪寄存器。这个位的值总是 1，表示可以访问 ETM 跟踪寄存器。 |



### 10.3.11. 集成测试杂项输入，ITMISCIN (Integration Test Miscellaneous Inputs)

ITMISCIN 寄存器特点：

目的：集成测试。

用法限制：没有。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_11-11-03.png)

| 位     | 名称       | 功能                                           |
| ------ | ---------- | ---------------------------------------------- |
| [31:5] | -          | 保留                                           |
| [4]    | COTEHALT   | 对该位的读取返回 **COREHALT** 输入引脚的值。   |
| [3:2]  | -          | 保留                                           |
| [1:0]  | EXTIN[1:0] | 对该位的读取返回 **EXTIN[1:0]** 输入引脚的值。 |



### 10.3.12. 集成测试触发输出，ITTRIGOUT (Integration Test Trigger Out)

ITTRIGOUT 寄存器特点：

目的：集成测试。

用法限制：你必须设置 **ETMITCTRL** 寄存器的 bit[0]， 才能使用这个寄存器。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_11-16-04.png)

| 位     | 名称                 | 功能                                    |
| ------ | -------------------- | --------------------------------------- |
| [31:1] | -                    | 保留                                    |
| [0]    | TRIGGER output value | 对该位的写入设置触发器 (TRIGGER) 输出。 |



### 10.3.13. ETM 集成测试 ATB 控制 2，ETM_ITATBCTR2 (ETM Integration Test ATB Control 2)

ETM_ITATBCTR2 寄存器特点：

目的：集成测试。

用法限制：你必须设置 **ETMITCTRL** 寄存器的 bit[0]， 才能使用这个寄存器。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_11-19-33.png)

| 位     | 名称                | 功能                                    |
| ------ | ------------------- | --------------------------------------- |
| [31:1] | -                   | 保留                                    |
| [0]    | ATREADY input value | 读取此位返回 **ETM ATREADY** 输入的值。 |



### 10.3.14. ETM 集成测试 ATB 控制 0，ETM_ITATBCTR0 (ETM Integration Test ATB Control 0)

ETM_ITATBCTR0 寄存器特点：

目的：集成测试。

用法限制：你必须设置 **ETMITCTRL** 寄存器的 bit[0]， 才能使用这个寄存器。

配置：仅在处理器配置使用 ETM 时有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 10\Snipaste_2019-07-17_11-23-01.png)

| 位     | 名称                 | 功能                                          |
| ------ | -------------------- | --------------------------------------------- |
| [31:1] | -                    | 保留                                          |
| [0]    | ATVALID output value | 对该位的写入将设置 **ETM ATVALID** 输出的值。 |

