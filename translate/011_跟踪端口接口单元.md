# 11. 跟踪端口接口单元 (Trace Port Interface Unit)

本章描述 Cortex-M3 TPIU，跟踪端口接口单元是针对 Cortex-M3 处理器特定的。包含以下部分：

- 关于 Cortex-M3 TPIU
- TPIU 功能描述
- TPIU 编程模型



## 11.1. 关于 Cortex-M3 TPIU (About the Cortex-M3 TPIU)

Cortex-M3 TPIU 是一个可选组件，它充当来自嵌入式跟踪宏单元 (ETM) 的芯片上跟踪数据与仪器跟踪宏单元 (ITM) 之间的桥梁，具有独立的 IDs，以发送到数据流。TPIU 在需要的地方封装 IDs，然后由跟踪端口分析器(TPA: Trace Port Analyzer) 捕获数据流。



Cortex-M3 TPIU 是专门为低成本调试而设计的。它是 CoreSight TPIU 的一个特殊版本。如果实现需要CoreSight TPIU 的其他特性，则可以使用其他 CoreSight 组件替换 Cortex-M3 TPIU。



在本章中，TPIU 指的是 Cortex-M3 TPIU 。有关 CoreSight TPIU，详见 **ARM CoreSight Components Technical Reference Manual** 。



## 11.2. TPIU 功能描述 (TPIU functional description)

TPIU 有 2 种配置：

- 支持 ITM 调试跟踪的配置。
- 支持 ITM 和 ETM 调试跟踪的配置。



如果实现不要求支持跟踪，则可能不存在 TPIU 。

注：如果你的 Cortex-M3 系统使用了可选的 ETM 组件，则 TPIU 配置支持 ITM 和 ETM 调试跟踪。详见第十章节。



### 11.2.1. TPIU 模块插图 (TPIU block diagrams)

图 11-1 展示了两种配置的 TPIU 组件布局。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_14-10-52.png)



### 11.2.2. TPIU 格式化程序 (TPIU Formatter)

格式化程序将源 ID 信号插入数据包流中，以便跟踪数据可以与其跟踪源重新关联。当跟踪端口模式 (TPM: Trace Port Mode) 处于活动状态时，格式化程序始终处于活动状态。

格式化的协议在 **CoreSight Architecture Specification** 中描述。必须启用 DWT 中的同步包，以便为格式化程序提供同步。

当启用格式化程序时，如果在启动帧之后没有数据要输出，则可以插入数据为 0x00 的 NULL ID 。帧完成后，将插入完整的同步包，直到准备输出新数据。



### 11.2.3. 串行线输出格式 (Serial Wire Output format)

TPIU 可以以串行线输出 (SWO: Serial Wire Output) 格式输出跟踪数据：

- **TPIU_DEVID** 指定了支持的格式。
- **TPIU_SPPR**  指定了正在使用的 SWO 格式。详见 **ARMv7-M Architecture Reference Manual** 。



当选择 两种 SWO 模式之一时，你可以使 TPIU 绕过格式化程序进行跟踪输出。如果绕过了格式化程序，

则只能通过 ITM 和 DWT 跟踪源。TPIU 从 ETM 接收和丢弃数据。此功能可用于将包含 ETM 的设备连接到仅能捕获 SWO 数据的跟踪捕获设备。



## 11.3. TPIU 编程模型 (TPIU programmers model)

表 11-1 列出了 TPIU 的寄存器。依赖你的实现，有的寄存器可能不存在，或者用 CoreSight TPIU 的替换了。读取不存在的寄存器将返回 0。

| 地址        | 名称        | 类型 | 复位值      | 描述                                                         |
| ----------- | ----------- | ---- | ----------- | ------------------------------------------------------------ |
| 0xE004_0000 | TPIU_SPPSR  | RO   | 0x0xx       | 支持并行端口大小寄存器 (Supported Parallel Port Size Register) |
| 0xE004_0004 | TPIU_CPPSR  | RW   | 0x01        | 当前并行端口大小寄存器 (Current Parallel Port Size Register) |
| 0xE004_0010 | TPIU_ACPR   | RW   | 0x0000      | 异步时钟预分频寄存器 (Asynchronous Clock Prescaler Register) |
| 0xE004_00F0 | TPIU_SPPR   | RW   | 0x01        | 选择的引脚协议寄存器 (Selected Pin Protocol Register)        |
| 0xE004_0300 | TPIU_FFSR   | RO   | 0x08        | 格式化程序和刷新状态寄存器 (Formatter and Flush Status Register) |
| 0xE004_0304 | TPIU_FFCR   | RW   | 0x102       | 格式化程序和刷新控制寄存器 (Formatter and Flush Control Register) |
| 0xE004_0308 | TPIU_FSCR   | RO   | 0x00        | 格式化程序同步计数寄存器 (Formatter Synchronization Counter Register) |
| 0xE004_0EE8 | TRIGGER     | RO   | 0x0         | 触发器 (TRIGGER)                                             |
| 0xE004_0EEC | FIFO data 0 | RO   | 0x--00_0000 | 集成 FIFO 0 数据 (Integration FIFO 0 Data)                   |
| 0xE004_0EF0 | ITATBCTR2   | RO   | 0x0         | ITATBCTR2                                                    |
| 0xE004_0EFC | FIFO data 1 | RO   | 0x--00_0000 | 集成 FIFO 1 数据 (Integration FIFO 1 Data)                   |
| 0xE004_0EF8 | ITATBCTR0   | RO   | 0x0         | ITATBCTR0                                                    |
| 0xE004_0F00 | ITCTRL      | RW   | 0x0         | 集成模式控制 (Integration Mode Control)                      |
| 0xE004_0FA0 | CLAIMSET    | RW   | 0xF         | 设置声明标识 (Claim tag set)                                 |
| 0xE004_0FA4 | CLAIMCLR    | RW   | 0x0         | 清除声明标识 (Claim tag clear)                               |
| 0xE004_0FC8 | DEVID       | RO   | -           | TPIU_DEVID                                                   |
| 0xE004_0FD0 | PID4        | RO   | 0x04        | 外设身份识别寄存器 (Peripheral identification registers)     |
| 0xE004_0FD4 | PID5        | RO   | 0x00        | 同上                                                         |
| 0xE004_0FD8 | PID6        | RO   | 0x00        | 同上                                                         |
| 0xE004_0FDC | PID7        | RO   | 0x00        | 同上                                                         |
| 0xE004_0FE0 | PID0        | RO   | 0xA1        | 同上                                                         |
| 0xE004_0FE4 | PID1        | RO   | 0xB9        | 同上                                                         |
| 0xE004_0FE8 | PID2        | RO   | 0x0B        | 同上                                                         |
| 0xE004_0FEC | PID3        | RO   | 0x00        | 同上                                                         |
| 0xE004_0FF0 | CID0        | RO   | 0x0D        | 组件身份识别寄存器 (Component identification Registers)      |
| 0xE004_0FF4 | CID1        | RO   | 0x90        | 同上                                                         |
| 0xE004_0FF8 | CID2        | RO   | 0x05        | 同上                                                         |
| 0xE004_0FFC | CID3        | RO   | 0xB1        | 同上                                                         |



以下描述了针对这个处理器指定实现的 TPIU 寄存器。格式化程序，集成模式控制和设置/清除声明标识，这几个寄存器在 **CoreSight Components Technical Reference Manual** 描述。其它的在 **ARMv7-M Architecture Reference Manual** 中描述。



### 11.3.1. 同步时钟预分频寄存器，TPIU_ACPR (Asynchronous Clock Prescaler Register)

TPIU_ACPR 寄存器的特点：

目的：降低异步输出的波特率。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_15-05-14.png)

| 位      | 名称      | 功能                                   |
| ------- | --------- | -------------------------------------- |
| [31:13] | -         | 保留，RAZ/SBZP                         |
| [12:0]  | PRESCALER | 对 **TRACECLKIN** 分频 (Prescaler + 1) |



### 11.3.2. 格式化程序和刷新状态寄存器，TPIU_FFSR (Formatter and Flush Status Register)

TPIU_FFSR 寄存器的特点：

目的：表示 TPIU 格式化程序的状态。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_15-10-22.png)

| 位     | 名称      | 功能               |
| ------ | --------- | ------------------ |
| [31:4] | -         | 保留               |
| [3]    | FtNonStop | 格式化程序不能停止 |
| [2]    | TCPresent | 该位读返回 0       |
| [1]    | FtStopped | 该位读返回 0       |
| [0]    | FlInProg  | 该位读返回 0       |



### 11.3.3. 格式化程序和刷新控制寄存器，TPIU_FFCR (Formatter and Flush Control Register)

TPIU_FFCR 寄存器的特点：

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_15-15-10.png)

| 位     | 名称    | 功能                                                         |
| ------ | ------- | ------------------------------------------------------------ |
| [31:9] | -       | 保留                                                         |
| [8]    | TrigIn  | 该位读返回 1 (RAO: Reads-As-One)，指定在断言触发器引脚时插入触发器。 |
| [7:2]  | -       | 保留                                                         |
| [1]    | EnFCont | 使能连续的格式。                                                                                                                        0 = 不使能连续格式                                                                                                            1 = 使能连续格式 |
| [0]    | -       | 保留                                                         |



TPIU 可以以串行线输出 (SWO: Serial Wire Output) 格式输出跟踪数据。当选择两个 SWO 模式之一时，**TPIU_FFCR** 的 bit[1] 位允许绕过格式化程序。如果绕过格式化程序，则只通过 ITM 和 DWT 跟踪源。
TPIU 从 ETM 接收和丢弃数据。此功能可用于将包含 ETM 的设备连接到仅能捕获 SWO 数据的跟踪捕获设备。启用或禁用格式化程序会导致瞬时数据损坏。



注：如果将 **TPIU_SPPR** 设置为选择并行端口模式，则格式化程序自动启用。如果你选择其中一种 SWO 模式，**TPIU_FFCR** 将恢复到先前编程的值。



### 11.3.4. 触发器 (TRIGGER)

TRRIGGER 寄存器的特点：

目的：TRIGGER 输出的集成测试。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_15-27-24.png)

| 位     | 名称                | 功能                       |
| ------ | ------------------- | -------------------------- |
| [31:1] | -                   | 保留                       |
| [0]    | TRIGGER input value | 读取时，此位返回触发器输入 |



### 11.3.5. 集成 FIFO 0 数据 (Integration FIFO 0 Data)

Integration FIFO 0 Data 寄存器的特点：

目的：跟踪数据集成测试。

用法限制：必须设置 **TPIU_ITCTRL** 的 bit[1]位，才能使用这个寄存器。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_15-31-18.png)

| 位      | 名称                 | 功能                                                         |
| ------- | -------------------- | ------------------------------------------------------------ |
| [31:30] | -                    | 保留                                                         |
| [29]    | FIFO 1 ATVALID input | 返回 **ATVALID2** 信号的值。                                 |
| [28:27] | FIFO 1 byte count    | 自上次读取集成 ITM 数据寄存器以来 FIFO 1 跟踪数据的字节数    |
| [26]    | FIFO 0 ATVALID input | 返回 **ATVALID1** 信号的值。                                 |
| [25:24] | FIFO 0 byte count    | 自上次读取集成 ITM 数据寄存器以来 FIFO 0 跟踪数据的字节数    |
| [23:16] | FIFO 0 data 2        | 如果 ETM 存在，这些字段包含 ETM 数据。如果不存在 ETM，则这些字段包含 ITM 数据。当读取寄存器时，TPIU 丢弃这些数据。 |
| [15:8]  | FIFO 0 data 1        | 同上                                                         |
| [7:0]   | FIFO 0 data 0        | 同上                                                         |



### 11.3.6. ITATBCTR2 

ITATBCTR2 寄存器的特点：

目的：集成测试。

用法限制：必须设置 **TPIU_ITCTRL** 的 bit[0] 位，才能使用这个寄存器。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_16-10-29.png)

| 位     | 名称               | 功能                                                         |
| ------ | ------------------ | ------------------------------------------------------------ |
| [31:1] | -                  | 保留                                                         |
| [0]    | ATREADY1, ATREADY2 | 如果 TPIU 处于集成测试模式，则此位设置为 ETM 和 ITM ATREADY 输出的值。 |



### 11.3.7. 集成 FIFO 1 数据 (Integration FIFO 1 Data)

Integration FIFO 1 Data 寄存器的特点：

目的：跟踪数据集成测试。

用法限制：必须设置 **TPIU_ITCTRL** 的 bit[1] 位，才能使用这个寄存器。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_16-16-51.png)

| 位      | 名称                 | 功能                                                         |
| ------- | -------------------- | ------------------------------------------------------------ |
| [31:30] | -                    | 保留                                                         |
| [29]    | FIFO 1 ATVALID input | 返回 **FIFO 1 ATVALID2** 信号的值。                          |
| [28:27] | FIFO 1 byte count    | 自上次读取集成 ITM 数据寄存器以来 FIFO 1 跟踪数据的字节数。  |
| [26]    | FIFO 0 ATVALID input | 返回 **FIFO 0 ATVALID1** 信号的值。                          |
| [25:24] | FIFO 0 byte count    | 自上次读取集成 ETM 数据寄存器以来 FIFO 0 跟踪数据的字节数。  |
| [23:16] | FIFO 1 data 2        | 如果存在 ETM，这些字段包含 ITM 跟踪数据。当读取寄存器时，TPIU丢弃这些数据。 |
| [15:8]  | FIFO 1 data 1        | 同上                                                         |
| [7:0]   | FIFO 1 data 0        | 同上                                                         |



### 11.3.8. ITATBCTR0 

ITATBCTR0 寄存器的特点：

目的：集成测试。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_16-23-06.png)

| 位     | 名称               | 功能                                                      |
| ------ | ------------------ | --------------------------------------------------------- |
| [31:1] | -                  | 保留                                                      |
| [0]    | ATVALID1, ATVALID2 | 读取此位将返回 **ATVALIDS1** 或 (和) **ATVALIDS2** 的值。 |



### 11.3.9. 集成模式控制，TPIU_ITCTRL (Integration Mode Control)

TPIU_ITCTRL 寄存器的特点：

目的：指定 TPIU 的正常模式或集成模式。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_16-27-15.png)

| 位     | 名称 | 功能                                                         |
| ------ | ---- | ------------------------------------------------------------ |
| [31:2] | -    | 保留                                                         |
| [1:0]  | Mode | 指定 TPIU 当前的模式：                                                                                                           b00 = 正常模式                                                                                                                             b01 = 集成测试模式                                                                                                                             b10 = 集成数据测试模式                                                                                                              b11 = 保留                                                                                                                                               在集成数据测试模式下，将禁用跟踪输出，并且可以使用集成数据寄存器直接从每个输入端口读取数据。 |



### 11.3.10. TPIU_DEVID

TPIU_DEVID 寄存器的特点：

目的：表示 TPIU 提供的用于拓扑检测的功能。

用法限制：没有。

配置：在处理器的所有配置中有效。

属性：如下表。

![](E:\Work\ARM\pictures\Chapter 11\Snipaste_2019-07-17_16-31-55.png)

| 位      | 名称                                         | 功能                                                         |
| ------- | -------------------------------------------- | ------------------------------------------------------------ |
| [31:12] | -                                            | 保留                                                         |
| [11]    | Asynchronous Serial Wire Output (NRZ)        | 这个位读取为 1 (RAO: Reads-As-One)，表示支持输出。           |
| [10]    | Asynchronous Serial Wire Output (Manchester) | 这个位读取为 1 (RAO: Reads-As-One)，表示支持输出。           |
| [9]     | Parallel trace port mode                     | 这个位读取为 0 (RAO: Reads-As-Zero)，表示支持并行跟踪端口模式。 |
| [8:6]   | Minimum buffer size                          | 指定最小 TPIU 缓冲区大小：                                                                         b010 = 4-Byte |
| [5]     | Asynchronous **TRACECLKIN**                  | 指定 **TRACECLKIN** 是否可以异步到 **CLK**：                                                          b1 = **TRACECLKIN** 可以与 **CLK** 异步。 |
| [4:0]   | Number of trace inputs                       | 指定跟踪输入的数量：                                                                                                 b00000 = 1 个输入                                                                                            b00001 = 2 个输入                                                                                                    如果实现包含 ETM，则该字段的值为 b000001。 |

