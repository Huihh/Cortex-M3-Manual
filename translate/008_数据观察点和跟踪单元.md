# 8. 数据观察点和跟踪单元 (Data Watchpoint and Trace Unit)

该章节描述数据观察点和跟踪单元 (DWT: Data Watchpoint and Trace unit)。 包含以下部分：

- 关于 DWT
- DWT 功能描述
- DWT 编程模型



## 8.1. 关于 DWT (About the DWT)

DWT 是个可选的调试单元，它为处理器提供了观察点 (watchpoints) 、数据跟踪 (data tracing) 和系统概要 (system profiling)。



## 8.2. DWT 功能描述 (DWT functional description)

一个完整的 DWT 包括 4 个比较器，你可以配置为：

- 一个硬件观察点
- 一个 ETM 触发器
- 一个 PC 采样事件触发器
- 一个数据地址采样事件触发器

第一个比较器 DWT_COMP0 也可以与时钟周期计数器进行比较，CYCCNT。还可以使用第二个比较器DWT_COMP1 作为数据比较器。

简化版的 DWT 包含一个比较器，可以用来作为观察点或作为触发器。不支持数据匹配。

如果存在 DWT 单元，则包含以下计数器：

- 时钟周期 (CYCCNT: clock cycles)
- 折叠指令 (folded instructions)
- 加载存储单元 (LSU: Load Store Unit) 操作 
- 睡眠周期 (sleep cycles)
- CPI，这就是除第一个周期外的所有指令周期 (that is all instruction cycles except for the first cycle)
- 中断开销 (interrupt overhead)

**注：每次计数器溢出时都会生成一个事件**。

可以配置 DWT 在定义的时间间隔产生 PC 采样，并生成中断事件信息。

如果你在实现中包括 Cortex-M3 TPIU，那么 DWT 提供定期请求协议同步到 ITM 和 TPIU。



## 8.3. DWT 编程模型 (DWT programmers model)

表 8-1 列出了 DWT 的寄存器。基于你处理器的实现，其中有些寄存器可能不存在。读不存在的寄存器应该返回 0。

| 地址        | 名称          | 类型 | 复位值                                                       | 描述                                                     |
| ----------- | ------------- | ---- | ------------------------------------------------------------ | -------------------------------------------------------- |
| 0xE000_1000 | DWT_CTRL      | RW   | 0x4000_0000 : 有 4 个比较器用于观察点和触发器                                                                      0x4F00_0000 : 有 4 个比较仅用于观察点                            0x1000_0000 : 仅有 1 个比较器                             0x1F00_0000 : 1 个比较器用于观察点且没有触发器                                                                         0x0000_0000 : DWT 不存在 | 控制寄存器 (Control Register)                            |
| 0xE000_1004 | DWT_CYCCNT    | RW   | 0x0000_0000                                                  | 周期计数寄存器 (Cycle Count Register)                    |
| 0xE000_1008 | DWT_CPICNT    | RW   | -                                                            | CPI 计数寄存器 (CPI Count Register)                      |
| 0xE000_100C | DWT_EXCCNT    | RW   | -                                                            | 异常开销计数寄存器 (Exception Overhead Count Register)   |
| 0xE000_1010 | DWT_SLEEPCNT  | RW   | -                                                            | 睡眠计数寄存器 (Sleep Count Register)                    |
| 0xE000_1014 | DWT_LSUCNT    | RW   | -                                                            | 加载存储单元计数 寄存器 (LSU Count Register)             |
| 0xE000_1018 | DWT_FOLDCNT   | RW   | -                                                            | 折叠指令计数寄存器 (Folded-instruction  Count Register)  |
| 0xE000_101C | DWT_PCSR      | RO   | -                                                            | 程序计数器采样寄存器(Program Counter Sample Register)    |
| 0xE000_1020 | DWT_COMP0     | RW   | -                                                            | 比较器寄存器0 (Comparator Register0)                     |
| 0xE000_1024 | DWT_MASK0     | RW   | -                                                            | 掩码寄存器0 (Mask Register0)                             |
| 0xE000_1028 | DWT_FUNCTION0 | RW   | 0x0000_0000                                                  | 功能寄存器0 (Function Register0)                         |
| 0xE000_1030 | DWT_COMP1     | RW   | -                                                            | 比较器寄存器1 (Comparator Register1)                     |
| 0xE000_1034 | DWT_MASK1     | RW   | -                                                            | 掩码寄存器1 (Mask Register1)                             |
| 0xE000_1038 | DWT_FUNCTION1 | RW   | 0x0000_0000                                                  | 功能寄存器1 (Function Register1)                         |
| 0xE000_1040 | DWT_COMP2     | RW   | -                                                            | 比较器寄存器2 (Comparator Register2)                     |
| 0xE000_1044 | DWT_MASK2     | RW   | -                                                            | 掩码寄存器2 (Mask Register2)                             |
| 0xE000_1048 | DWT_FUNCTION2 | RW   | 0x0000_0000                                                  | 功能寄存器2 (Function Register2)                         |
| 0xE000_1050 | DWT_COMP3     | RW   | -                                                            | 比较器寄存器3 (Comparator Register3)                     |
| 0xE000_1054 | DWT_MASK3     | RW   | -                                                            | 掩码寄存器3 (Mask Register3)                             |
| 0xE000_1058 | DWT_FUNCTION3 | RW   | 0x0000_0000                                                  | 功能寄存器3 (Function Register3)                         |
| 0xE000_1FD0 | PID4          | RO   | 0x04                                                         | 外设身份标识寄存器 (Peripheral identification registers) |
| 0xE000_1FD4 | PID5          | RO   | 0x00                                                         | 同上                                                     |
| 0xE000_1FD8 | PID6          | RO   | 0x00                                                         | 同上                                                     |
| 0xE000_1FDC | PID7          | RO   | 0x00                                                         | 同上                                                     |
| 0xE000_1FE0 | PID0          | RO   | 0x02                                                         | 同上                                                     |
| 0xE000_1FE4 | PID1          | RO   | 0xB0                                                         | 同上                                                     |
| 0xE000_1FE8 | PID2          | RO   | 0x3B                                                         | 同上                                                     |
| 0xE000_1FEC | PID3          | RO   | 0x00                                                         | 同上                                                     |
| 0xE000_1FF0 | CID0          | RO   | 0x0D                                                         | 组件身份识别寄存器 (Component identification registers)  |
| 0xE000_1FF4 | CID1          | RO   | 0xE0                                                         | 同上                                                     |
| 0xE000_1FF8 | CID2          | RO   | 0x05                                                         | 同上                                                     |
| 0xE000_1FFC | CID3          | RO   | 0xB1                                                         | 同上                                                     |



DWT 的寄存器在 **ARMv7M Architecture Reference Manual** 中描述。外设身份识别寄存器和组件身份识别寄存器在 **ARM CoreSight Components Technical Reference Manual** 中描述。

注：

- 周期匹配功能只有在比较器 0 中有效。
- 数据匹配功能只有在比较器 1 中有效。
- 数据值是仅采样那些不会产生 MPU 或 总线 Fault 的访问。不管发生什么 faults，PC 都会被采样。PC 只采样一个突发事件 (burst) 的第一个地址。
- 如果在 **DWT_FUNCTION1** 寄存器中设置了 **DATAVMATCH** 字段，则 **DWT_FUNCTION1** 寄存器中的 **FUNCTION** 字段会被 **DATAVADDR0** 和 **DATAVADDR1** 提供的比较器覆盖。**DATAVADDR0** 和**DATAVADDR1** 提供的比较器只能对比较器 1 的数据匹配执行地址比较器匹配。
- 如果没有实现数据匹配，则不能设置 **DWT_FUNCTION1** 寄存器中的 **DATAVADDR0** ，**DATAVADDR1** 或 **DATAVMATCH** 字段。这意味着数据匹配功能不可用。可以通过读写 **DWT_FUNCTION1** 寄存器中的 **DATAVMATCH** 字段测试数据匹配是否有效。如果这个字段不能设置则表明数据匹配不可用。
- 不建议在观察点使用 PC 匹配，因为它会在指令之后停止。它主要是保护和触发 ETM。