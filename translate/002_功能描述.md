# 2. 功能描述 (Functional Description)

该章节将介绍处理器和它自己的外部接口。包含以下部分：

- 关于功能
- 接口



## 2.1. 关于功能 (About the functions)

下图显示 Cortex-M3 处理器的结构：

![](E:\Work\ARM\pictures\Chapter 2\Snipaste_2019-07-04_14-35-16.png)

Cortex-M3 处理器特点：

- 低门数的处理器核心，低中断时延处理：

  - Thumb 指令集的子集，定义在 **ARMv7-M Architecture Reference Manual** 。
  - 备份的堆栈指针 (SP: Stack Pointer) 。
  - 硬件除法指令，SDIV 和 UDIV 。
  - Handler 和 Thread 模式。
  - Thumb 和 Debug 状态。
  - 为降低中断时延，支持可中断继续 (interruptible-continued) 的指令 LDM，STM，PUSH 和 POP。
  - 为降低中断时延，处理器的状态在中断服务例程 (ISR: Interrupt Servuce Routine) 进入和退出时自动保存和恢复。
  - 支持 ARMv6 大端字节不变或小端访问。
  - 支持 ARMv6 非对齐访问。
  
- 嵌套向量中断控制器 (NVIC: Nested Vectored Interrupt Controller) 与处理器核心紧密集成，以达到低延迟中断处理。特点包括：

  - 1 - 240 个可配置的外部中断。
  - 3 - 8 位用于可配置的优先级。
  -  动态改变中断优先级。
  - 优先级分组。这允许选择抢占中断级别和非抢占中断级别。
  - 支持咬尾 (tail-chaining) 中断和晚到 (late arrival) 中断。这支持中断连续处理，而不需要在中断之间进行状态保存和恢复。即免去了中断间的出栈入栈操作。
  - 处理器状态在中断进入时自动保存，在中断退出时自动恢复，没有指令开销。
  - 可选的唤醒中断控制器 (WIC: Wake-up Interrupt Controller)，支持超低功耗 (ultra-low power) 睡眠。

- 内存保护单元 (MPU: Memory Protection Unit)。MPU 为可选项，包括：

  - 8 个内存区域。
  - 子区域禁用 (SRD: Sub Region Disable)，高效的使用内存区域。
  - 启用实现默认内存映射属性的后台区域 (background region) 的能力。

- 总线接口：

  - 3 个高性能总线接口 (AHB-Lite: Advanced High-performance Bus-Lite)：ICode，DCode 和 System 总线接口。
  - 基于高级外设总线接口 (APB: Advanced Peripheral Bus) 的私有外设总线 (PPB: Private Peripheral Bus)。
  - 位带支持，包括原子位带写和读操作。
  - 内存访问对齐。
  - 用于缓冲写数据的写缓冲区。
  - 多处理器系统的独占访问传输。

- 低成本 (Low-cost) 的调试解决方案和特点：

  - 调试可以访问系统中的所有内存和寄存器，包括对内存映射设备的访问，内核停止时对内部核心寄存器的访问和在断言 SYSRESETn 发生时，也可以访问调试控制寄存器。
  - 支持 SW-DP 和 SWJ-DP 中的一种调试访问，或两种都支持。
  - 可选的闪存补丁和断点 (FPB) 单元，用于实现断点和指令补丁。
  - 可选的数据观察点和跟踪 (DWT) 单元，用于实现观察点，数据跟踪和系统分析。
  - 可选的仪器跟踪宏 (ITM) 单元，用于支持 **printf** 风格的调试。
  - 可选的跟踪端口接口 (TPIU) 单元，用于桥接到跟踪端口分析器 (TPA)，包括单线输出 (SWO) 模式。 
  - 可选的嵌入式跟踪宏 (ETM)，用于指令跟踪。

  

 ## 2.2. 接口 (Interfaces)

处理器包含以下几个外部接口：

- 总线接口
- ETM 接口
- AHB 跟踪宏接口
- 调试端口 AHB-AP 接口



### 2.2.1.  总线接口 (Bus interfaces)

处理器包含 4 个外部高性能总线接口 (AHB-Lite)：

- ICode 内存总线

  取指地址范围，从地址 0x0000_0000 ~ 0x1FFF_FFFF (0.5GB) 取指，在 32-bit 的 AHB 总线上执行。

  调试器不能访问这个接口。按字(word-wide) 取指。每次取指的数量取决于正在运行的代码和内存中代码的对齐方式。

- DCode 内存总线

  数据和调试访问内存范围，从 0x0000_0000 ~ 0x1FFF_FFFF (0.5GB)，在 32-bit ABHB-Lite 总线上执行。在 **DCode** 总线上，内核数据访问的优先级高于调试访问。也就是说，如果同时在总线上存在内核和调试访问时，调试访问必须等待内核访问完成之后再进行。

  在这个接口中，控制逻辑将未对齐的数据和调试访问转换为两个或三个对齐的访问，这取决于不对齐访问的大小和对齐。这将停止任何后续数据或调试访问，直到未对齐的访问完成。

  注：ARM 强烈建议，ICode 和 DCode 的 AHB 总线接口之间的任何外部仲裁都应确保 DCode 具有比 ICode 更高的优先级。

- System 接口

  取指，取数据和调试访问内存范围，从 0x2000_0000 ~ 0xDFFF_FFFF (3.0GB) 和 0xE010_0000 ~ 0xFFFF_FFFF (511MB)，在 32-bit AHB-Lite 总线上执行。

  对于同时访问该总线，优先级递减的仲裁顺序如下 (依次递减) ：

  - 数据访问
  - 指令和向量取指
  - 调试

  system 总线接口包含一个控制逻辑，用于处理非对齐访问，FPB 重映射访问，位带访问和流水线取指。

- 私有外设总线 (PPB)

  数据和调试访问的额外 PPB 空间范围，从 0xE004_0000 ~ 0xE00F_FFFF (768KB)，在 32-bit  APB 总线上执行。跟踪端口接口单元 (TPIU) 和供应商特定的外设也在该总线上执行。

  核心数据访问比调试访问的优先级高，因此，在总线上同时存在核心访问和调试访问时，调试访问只有在核心访问完成之后才能在总线上执行。这个接口只支持解码外部 PPB 空间所需的地址位。



### 2.2.2. 嵌入式跟踪宏接口 (ETM interface)

ETM 接口支持将 ETM 简单地连接到处理器。它为到 ETM 的指令跟踪提供了一个通道。详见  **ARM Embedded Trace Macrocell Architecture Specification** 。



### 2.2.3. AHB 跟踪宏接口 (AHB Trace Macrocell interface)

AHB 跟踪宏接口支持将 HTM (AHB Trace Macrocell) 简单地连接到处理器。它为到 HTM 的数据跟踪提供了一个通道。

实现必须包含此接口时才能使用 HTM 接口。在启用 HTM 以使 HTM 端口能够提供跟踪数据之前，需要将 调试异常和监视控制寄存器 (DEMCR: Debug Exception and Monitor Control Register) 中的 TRCENA 字段置 1。详见 **ARMv7-M Architecture Reference Manual** 。



### 2.2.4. 调试端口 AHB-AP 接口 (Debug Port AHB-AP interface)

处理器包含一个用于调试访问的高性能总线访问端口的接口 (AHB-AP: Advanced High-performance Bus Access Port) 。外部的调试端口 (DP: Debug Port) 组件访问这个接口。Cortex-M3 系统支持以下 3 种可能的 DP 实现：

- SWJ-DP：SWJ-DP 是 标准的 CoreSight 调试端口，它结合了 JTAG-DP 和 SW-DP。
- SW-DP：它提供两线 (two-pin) 接口访问 AHB-AP 端口。
- 不存在 DP。如果处理器中没有调试功能，那么也就不需要 DP。

两种 DP 实现，为调试访问处理器提供了不同的机制。实现必须包含这些组件中的一个。

注：可以使用实现者指定 (implementor-specific) 的 DP 代替 SW-DP 或 SWJ-DP。 

更多关于 DP 组件的信息，详见 **CoreSight Components Technical Reference manual** 。

更多 AHB-AP 的信息，参见第七章节-调试。

DP 和 AP 整合在一起称之为调试访问端口 (DAP: Debug Access Port)。

更多调试接口的信息，详见 **ARM Debug Interface v5 Architecture Specification** 。

